var mainpageModule=angular.module("MDM.mainpage2",["ngRoute"]);mainpageModule.controller("mainpageCtrl",["$scope","$filter","LoginCredsFactory","PlatwareRequest","parsePlatwareResponse","validateFileData","dmDialogueBox","$location","prepareDwnldData","batchDataService","entityListService","orgIdService",function(n,k,h,a,e,d,f,g,c,b,m,l){n.showScreenControls.proceedEntity=false;n.showScreenControls.showProceedButtons=true;n.showScreenControls.showTemplateOption=false;n.showScreenControls.showFileUploadButton=false;n.showScreenControls.showTable=false;n.showScreenControls.showSlideUpIcon=false;n.showScreenControls.showBatchId=false;n.showMappingIcons=false;n.showScreenControls.showFileUploadResult=false;n.showScreenControls.showcreateMapping=false;n.showScreenControls.showchangeMapping=false;n.showScreenControls.createMappingSection=false;n.showScreenControls.showStagingTable=false;n.showScreenControls.showStaging=false;n.showScreenControls.showMaster=false;n.showScreenControls.showRejected=false;n.showNotification=false;n.showScreenControls.showcreateMappingResults=false;n.showCreateResultSection1=false;n.showCreateResultSection3=false;n.showCreateResultSection2=false;n.showScreenControls.showfileUpload=false;n.showScreenControls.showRejectedTable=false;n.generatedFileTable=false;n.showScreenControls.showMasterTable=false;n.showScreenControls.showOrgOptions=false;n.showScreenControls.showProceedAction=true;n.showScreenControls.showSubmitButton=false;n.slideIcon="fa-chevron-down";n.templateName="";n.curBatchId="";n.filePath="";n.excelcolheader=[];n.changeMappedHeaders=[];n.tableData=[];n.droppedData=[];n.mappingAttributeId=[];n.mappingRecordId=[];n.entityExcelMapping=[];n.path.fullPath=[];n.icon=[{iconname:"fa-chevron-right"},{iconname:"fa-chevron-left"},{iconname:"fa-arrow-left"},{iconname:"fa-arrow-right"}];n.mappingOptions=[{id:"1",type:"One to One"},{id:"2",type:"Map All"}];n.stagingData=[];n.showScreenControls.sheetsObj={selectedSheet:"",sheets:[]};n.$on("sessionValidateEvent",function(p,o){if(o){n.init();try{}catch(p){}}else{f.alertBox({title:"Error",message:"Invalid user or session, kindly login again",actionlabel:["Ok"]}).then(function(q){g.path("/login")})}});n.serverError=function(){f.alertBox({title:"Server Error",message:"Server not responding",actionlabel:["Ok"]}).then(function(o){})};n.mainpageload=function(){n.showLoader();var o=[{processName:"SPORGID",data:[]}];a.callPlatware(o).success(function(p){var r=e.parse(p);n.hideLoader();for(var q=0;q<r.length;q++){if(r[q].isError=="N"){if(r[q].processName=="SPORGID"){n.OrgNames.OrgList=r[q].data}if(n.OrgNames.OrgList.length==1){n.selectOrgs(n.OrgNames.OrgList[0]);l.setOrgId(JSON.stringify(n.OrgNames.OrgList[0]));n.showScreenControls.orgItem=n.OrgNames.OrgList[0]}else{n.showScreenControls.showOrgOptions=true}}else{f.alertBox({title:"Alert",message:"Unable to get orgId",actionlabel:["Ok"]}).then(function(s){})}}}).error(function(){n.hideLoader();n.serverError()})};n.selectOrgs=function(o){n.currentOrg={id:o.orgid,name:o.orgid};n.orgName={};n.path.fullPath=[];n.orgName.name=n.currentOrg.name;n.orgName.action="org";n.showScreenControls.showOrgOptions=false;n.showScreenControls.showProceedAction=true;n.showScreenControls.showProceedButtons=true;n.showScreenControls.optsClass==="slide-up"?n.showScreenControls.optsClass="slide-down":"";n.showScreenControls.proceedEntity=false};n.init=function(){n.mainpageload()};n.uploadData=function(o){n.showScreenControls.showProceedButtons=false;n.action_name=o;n.actionName.name=n.action_name;n.actionName.action="action";n.setPath(n.actionName);switch(n.action_name){case"Upload Data":n.entityItem="";n.showScreenControls.headers=[];n.headingShown="upload";n.getentitylist();n.showScreenControls.proceedEntity=true;n.templateItem=null;n.fileInput=document.getElementById("UploadFileInput");break;case"Create Mapping":n.headingShown="create";n.getentitylist();n.showScreenControls.proceedEntity=true;n.templateItem=null;n.showScreenControls.showTemplateOption=false;n.fileInput=document.getElementById("createFileInput");break;case"Change Mapping":n.headingShown="change";n.showScreenControls.headers=[];n.getentitylist();n.showScreenControls.proceedEntity=true;n.templateItem=null;n.fileInput=document.getElementById("changeFileInput");break;case"Staging Data":n.showScreenControls.showProceedAction=false;n.showScreenControls.showStaging=true;n.showScreenControls.proceedEntity=true;n.stagingEntityItem="";n.getentitylist();break;case"Master Data":n.showScreenControls.showProceedAction=false;n.showScreenControls.proceedEntity=true;n.showScreenControls.showMaster=true;n.masterEntityItem="";n.getentitylist();break;case"Rejected Data":n.showScreenControls.showProceedAction=false;n.showScreenControls.proceedEntity=true;n.showScreenControls.showRejected=true;n.getentitylist();break}if(n.action_name!="Staging Data"){n.fileInput.addEventListener("click",function(){n.fileInput.removeEventListener("change",n.readFileForWorker);n.fileInput.value="";n.showScreenControls.sheetsObj.selectedSheet="";n.showScreenControls.showBatchId=false;n.fileInput.addEventListener("change",n.readFileForWorker)})}n.showScreenControls.proceedEntity=true};n.inputClick=function(){n.fileInput.click()};n.getentitylist=function(){n.showLoader("Loading Entities");var o=[{processName:"SPENTITYLIST",data:[{x_org_id:n.currentOrg.id}]}];a.callPlatware(o).success(function(p){var r=e.parse(p);n.hideLoader();for(var q=0;q<r.length;q++){if(r[q].isError=="N"){if(r[q].processName=="SPENTITYLIST"){n.entityList=r[q].data;m.setEntityList(n.entityList)}}else{f.alertBox({title:"Response Error",message:"Error occured while getting entity",actionlabel:["Ok"]}).then(function(s){})}}}).error(function(){n.hideLoader();n.serverError()})};n.dmTableAction=[{column_name:"view_btn",action_function:"tableAction"}];n.tableAction=function(q){var p=q;var o=p["batch id"];if(o.length<=0){f.alertBox({title:"Alert",message:"Batch Id cannot be blank",actionlabel:["Ok"]}).then(function(r){})}else{g.path("/batchData/"+o+"/"+n.currentEntity.id)}};n.setStagingBatchAttribute=function(o){n.filePath="";n.currentEntity={id:o.entityid,name:o.entitydescription,showStaging:o.showstagingdata,showMaster:o.showmasterdata};n.entityName={};n.entityName.name=n.currentEntity.name;n.entityName.action="entity";n.setPath(n.entityName);g.path("/batch/"+n.currentEntity.id);n.$broadcast("switchTab","staging data")};n.selectEntity=function(o){n.filePath="";n.currentEntity={id:o.entityid,name:o.entitydescription,showStaging:o.showstagingdata,showMaster:o.showmasterdata};n.entityName={};n.entityName.name=n.currentEntity.name;n.entityName.action="entity";n.setPath(n.entityName);n.showUploadType();if(n.action_name=="Upload Data"){n.templateItem="";n.editEntity();n.getTemplate();n.getStagingData(n.action_name);n.showScreenControls.showTemplateOption=true}else{if(n.action_name=="Create Mapping"){n.droppedData=[];n.showScreenControls.showFileUploadButton=true;n.showScreenControls.showcreateMapping=true}else{if(n.action_name=="Change Mapping"){n.droppedData=[];n.getTemplate();n.showScreenControls.showTemplateOption=true;n.showScreenControls.showchangeMapping=false}else{if(n.action_name=="Staging Data"){n.getStagingData(n.action_name,n.stagingDataTable);n.showScreenControls.showStagingTable=true}else{if(n.action_name=="Master Data"){n.getMasterData("0",n.action_name,n.masterDataTable)}else{if(n.action_name=="Rejected Data"){n.getRejectionData(n.action_name,n.rejectedDataTable)}}}}}}};n.stagingDataTable=function(o){n.stagingTable2Data=o};n.masterDataTable=function(o){n.masterTableData=o;n.collectiveServerCalls={showServerPagination:true,totalRecordCount:o[0]["total_records"],batchCount:o[0]["batch_count"]};n.showScreenControls.showMasterTable=true};n.rejectedDataTable=function(o){n.rejectedTableData=o;n.showScreenControls.showRejectedTable=true};n.getTemplate=function(){n.showLoader("Loading Template");var o=[{processName:"SPTEMPLETELIST",data:[{x_orgid:n.currentOrg.name,x_entityid:n.currentEntity.id}]}];a.callPlatware(o).success(function(p){var r=e.parse(p);n.hideLoader();for(var q=0;q<r.length;q++){if(r[q].isError=="N"){n.templateList=r[q].data;if(r[q].data.length==1){n.templateItem=n.templateList[q]}}else{f.alertBox({title:"Alert",message:"Unable to get template list",actionlabel:["Ok"]}).then(function(s){})}}}).error(function(p){n.hideLoader();n.serverError()})};n.selectTemplate=function(p){n.currentTemplate={id:p.templateid,name:p.filename};var o=k("byProp")(n.templateList,"templateid",n.currentTemplate.id);n.filePath=o[0]["filepath"];if(n.action_name=="Upload Data"){n.getUpdateTemplateHeaders(n.setheaders);n.showScreenControls.showfileUpload=true;n.showScreenControls.showFileUploadResult=true;n.showScreenControls.showFileUploadButton=true}else{if(n.action_name=="Change Mapping"){n.getUpdateTemplateHeaders();n.showScreenControls.showFileUploadButton=true;n.showScreenControls.showchangeMapping=true}}};n.getUpdateTemplateHeaders=function(p){n.showLoader("Loading Headers");var o=[{processName:"SPTEMPATTRIBUTEMAPPING",data:[{x_templateid:n.currentTemplate.id,x_entityid:n.currentEntity.id}]}];a.callPlatware(o).success(function(q){var u=e.parse(q);n.hideLoader();n.droppedData=[];n.excelcolheader=[];n.attributeNameList=[];for(var t=0;t<u.length;t++){if(u[t].isError=="N"){n.templateData=u[t].data;if(n.templateData==""){f.alertBox({title:"Template Alert",message:"Template is Empty",actionlabel:["Ok"]}).then(function(v){});n.showScreenControls.showFileUploadResult=false}else{n.templateData=k("orderObjectBy")(n.templateData,"attributeid");for(j=0;j<n.templateData.length;j++){var r=n.templateData[j]["attributename"];n.attributeNameList.push(r);n.colheader=n.templateData[j]["excelcolumnheader"].trim();n.excelcolheader.push(n.colheader);var s={};s.data=n.templateData[j]["excelcolumnheader"];n.droppedData.push(s)}}}else{f.alertBox({title:"Alert",message:"Response Error",actionlabel:["Ok"]}).then(function(v){})}if(p){p()}}}).error(function(q){n.hideLoader();n.serverError()})};n.setheaders=function(){n.showScreenControls.headers=n.excelcolheader};n.icontoggle=function(){n.showScreenControls.optsClass==="slide-up"?n.showScreenControls.optsClass="slide-down":n.showScreenControls.optsClass="slide-up";n.slideIcon==="fa-chevron-down"?n.slideIcon="fa-chevron-up":n.slideIcon="fa-chevron-down";n.$apply()};n.readFileForWorker=function(r){var p=n.fileInput.files[0];var q=/csv.*/;n.fileName=p.name;var p=r.target.files[0];var o={file:p};n.showLoader("Getting File Data");var s=d.readFileData(o);n.$apply();s.then(function(t){if(t[0]["errorMessage"]!=""){n.hideLoader();f.alertBox({title:"File Error",message:t[0]["errorMessage"]});return}switch(t[0]["fileType"].toLowerCase()){case"xls":case"xlsx":n.showScreenControls.sheetsObj.sheets=t[0]["sheets"];n.showScreenControls.sheetsObj.sheetsData=t[0]["fileData"];if(n.showScreenControls.sheetsObj.sheets&&n.showScreenControls.sheetsObj.sheets.length==1){n.showScreenControls.sheetsObj.selectedSheet=n.showScreenControls.sheetsObj.sheets[0];n.readSheetData()}n.hideLoader();break;case"csv":n.validate(t[0]["fileData"]);break;default:}})};n.readSheetData=function(){if(n.showScreenControls.sheetsObj.selectedSheet){var o=n.showScreenControls.sheetsObj.sheetsData[n.showScreenControls.sheetsObj.selectedSheet];n.validate(o)}else{return}};n.getSelectedSheetData=function(){if(n.showScreenControls.sheetsObj.sheets&&n.showScreenControls.sheetsObj.sheets.length<=1){return}n.readSheetData()};n.validate=function(q){n.workerConfig=null;if(n.action_name=="Create Mapping"){}else{if(n.action_name=="Create Mapping"){}else{if(n.action_name=="Create Mapping"){}}}switch(n.action_name.toLowerCase()){case"create mapping":case"change mapping":break;case"upload data":n.workerConfig={messageCount:2};break;default:break}var p=k("extractProperty")(n.templateData,"excelcolumnheader");p=k("replaceInArray")(p,/,/g,"^^");var o={key1:q,key2:n.attributeList,key3:p,key4:[],key5:n.action_name,key6:[],key7:[]};var r=d.doWork(o,n.workerConfig);n.showLoader("Validating File Data");r.then(function(w){var v;var x;switch(n.action_name.toLowerCase()){case"create mapping":case"change mapping":for(var t=0,s=w.length;t<s;t++){if(w[t]["type"].toLowerCase()!=="tabledata"){x=w[t];v=x.type.toLowerCase();u(v,x)}}break;case"upload data":for(var t=0,s=w.length;t<s;t++){if(w[t]["type"].toLowerCase()!=="headers"){x=w[t];v=x.type.toLowerCase();u(v,x)}}break;default:break}function u(z,A){switch(z){case"headers":if(n.action_name=="Create Mapping"){n.showScreenControls.headers=A.data;n.showScreenControls.createMappingSection=true;n.showNotification=true;n.showScreenControls.showSubmitButton=true;n.showCreateResultSection2=true;n.showCreateResultSection3=true}else{if(n.action_name=="Change Mapping"){n.showScreenControls.headers=A.data;n.changeMappingSection=true;n.showNotification=true;n.showScreenControls.showSubmitButton=true}}break;case"tabledata":var y;A.data?y=A.data:y=[];n.tableData=y;if(y.length>0){n.curBatchId=b.getBatchId();n.showScreenControls.showBatchId=true}else{n.curBatchId=""}n.showScreenControls.showSlideUpIcon=true;n.showScreenControls.showTable=true;x?n.showScreenControls.optsClass="slide-up":"";n.hideLoader();n.$digest();break;case"error":f.alertBox({title:"File Alert",message:A.message,actionlabel:["Ok"]}).then(function(B){});n.showScreenControls.showTable=false;n.hideLoader();return;break}}})};n.showUploadType=function(){var o=[{processName:"SPENTITYATTRIBUTES",data:[{x_entityid:n.currentEntity.id}]}];a.callPlatware(o).success(function(p){var t=e.parse(p);if(t.length>0){var r=[];n.canUploadFile=true;for(var s=0;s<t.length;s++){if(t[s].isError=="N"){n.attributeList=t[s].data;n.generateFileHeaders();var v=n.attributeList.length;for(var q=0;q<v;q++){var u={};u.data="";n.droppedData.push(u);n.attributeId=n.attributeList[q]["attributeid"];n.mappingAttributeId.push(n.attributeId);n.recordId=n.attributeList[q]["recordid"];n.mappingRecordId.push(n.recordId);n.forbiddengroupId=n.attributeList[q]["forbiddengroupid"];n.validvaluesgroupid=n.attributeList[q]["validvaluesgroupid"]}n.createTemplateAttributeId=n.mappingAttributeId.join(",")}else{f.alertBox({title:"Alert",message:"Response Error",actionlabel:["Ok"]}).then(function(w){})}}}}).error(function(p){n.hideLoader();n.serverError()})};n.downloadFile=function(){if(n.filePath.length>0){if(n.filePath.indexOf("webapps")>-1){var p=n.filePath.split("webapps");var o=window.location.protocol+"//"+window.location.host+p[1]}else{var p=n.filePath;var o=window.location.protocol+"//"+window.location.host+p}window.open(o,"_blank")}};n.onDragStart=function(p){var o=angular.element(p).scope().$index;n.dataTransfer=o};n.onDragEnter=function(p,o){o.preventDefault()};n.onDragOver=function(q,o){var p=angular.element(q).scope().$index;n.isDrag=p;n.$apply();o.preventDefault()};n.onDrop=function(q,o){n.isDrag=null;var p=angular.element(q).scope().$index;n.droppedData[p]["data"]=n.showScreenControls.headers[n.dataTransfer];n.showScreenControls.headers.splice(n.dataTransfer,1);n.$apply()};n.mappingIcon=function(p){switch(p){case"fa-chevron-right":for(var o=0;o<n.droppedData.length;o++){n.showScreenControls.headers[o]=n.droppedData[o]["data"];n.droppedData[o]["data"]=""}n.$apply();break;case"fa-chevron-left":for(var o=0;o<n.showScreenControls.headers.length;o++){n.droppedData[o]["data"]=n.showScreenControls.headers[o]}n.showScreenControls.headers=[];break;case"fa-arrow-left":if(n.selectedMappedHeaderIndex!=null&&n.selectedFileHeaderIndex!=null&&n.showScreenControls.headers[n.selectedFileHeaderIndex]!==""){n.droppedData[n.selectedMappedHeaderIndex]["data"]=n.showScreenControls.headers[n.selectedFileHeaderIndex];n.showScreenControls.headers[n.selectedFileHeaderIndex]="";n.selectedMappedHeaderIndex=null;n.$apply();n.selectedFileHeaderIndex=null}else{f.alertBox({title:"Data Mapping Alert",message:"Sorry! No data to replace..",actionlabel:["Ok"]}).then(function(q){})}break;case"fa-arrow-right":if(n.selectedMappedHeaderIndex!=null&&n.selectedFileHeaderIndex!=null&&n.droppedData[n.selectedMappedHeaderIndex]["data"]!==""){n.showScreenControls.headers[n.selectedFileHeaderIndex]=n.droppedData[n.selectedMappedHeaderIndex]["data"];n.droppedData[n.selectedMappedHeaderIndex]["data"]="";n.selectedMappedHeaderIndex=null;n.selectedFileHeaderIndex=null}else{f.alertBox({title:"Data Mapping Alert",message:"Sorry! No data to replace..",actionlabel:["Ok"]}).then(function(q){})}}};n.submitTemplateUploadData=function(){var p=n.droppedData.length;var r=k("unique")(n.droppedData,"data").length;var o=n.checkForMappedHeaders();if(o==false){f.alertBox({title:"Alert",message:"Please Map All Headers",actionlabel:["Ok"]}).then(function(s){})}else{if(p!=r){f.alertBox({title:"Alert",message:"New Template Headers must have unique value",actionlabel:["Ok"]}).then(function(s){})}if(!n.templateName){f.alertBox({title:"Name Alert",message:"Please Enter Template Name",actionlabel:["Ok"]}).then(function(s){})}else{var q=[{processName:"CREATENEWTEMPLATE",data:[{x_orgid:n.currentOrg.id,x_entityid:n.currentEntity.id,x_filename:n.templateName,x_filepath:"",x_sheetname:n.selectSheetName}]}];n.showLoader("Creating New Template")}a.callPlatware(q).success(function(t){var s=e.parse(t);n.hideLoader();if(s[0].data[0].issuccess=="Y"){n.createTemplateId=s[0].data[0].template_id||"";if(n.createTemplateId.length>0){n.insertMapping();f.confirmBox({title:"Success",message:"New Template Created Successfully",actionlabel:["Go To Homepage","Upload Data For This Entity"]}).then(function(u){if(!u){n.reset();n.removePath(1)}if(u){n.removePath(1);n.editEntity();n.uploadData("Upload Data")}})}}else{f.alertBox({title:"Name Alert",message:"Unable to create template at the moment. Please try again",actionlabel:["Ok"]}).then(function(u){})}}).error(function(s){n.hideLoader();n.serverError()})}};n.insertMapping=function(){for(i=0;i<n.attributeList.length;i++){n.newTemplateHeaders={};n.newTemplateHeaders.x_templateid=n.createTemplateId,n.newTemplateHeaders.x_recordid=n.mappingRecordId[i],n.newTemplateHeaders.x_excelcolumnheader=n.droppedData[i].data,n.newTemplateHeaders.x_attributeid=n.mappingAttributeId[i];n.entityExcelMapping.push(n.newTemplateHeaders)}var o=[{processName:"INSERTMAPPING",data:n.entityExcelMapping}];a.callPlatware(o).success(function(p){var q=e.parse(p)}).error(function(p){n.hideLoader();n.serverError()})};n.submitChangedTemplateData=function(){var p=n.droppedData.length;var r=k("unique")(n.droppedData,"data").length;var o=n.checkForMappedHeaders();if(o==false){f.alertBox({title:"Alert",message:"Please Map All Headers",actionlabel:["Ok"]}).then(function(s){})}else{if(p!=r){f.alertBox({title:"Alert",message:"Mapped Headers Must have unique value",actionlabel:["Ok"]}).then(function(s){})}else{for(i=0;i<n.attributeList.length;i++){n.changedTemplateHeaders={};n.changedTemplateHeaders.X_TEMPLATEID=n.currentTemplate.id,n.changedTemplateHeaders.X_ATTRIBUTEID=n.mappingAttributeId[i],n.changedTemplateHeaders.X_NEW_COLUMNHEADER=n.droppedData[i].data;n.changeMappedHeaders.push(n.changedTemplateHeaders)}var q=[{processName:"UPDATEMAPPINGDETAILS",data:n.changeMappedHeaders}];n.showLoader("Changing Headers Mapping");a.callPlatware(q).success(function(s){var t=e.parse(s);n.hideLoader();if(t[0].data[0].message=="Y"){f.confirmBox({title:"Success",message:"Mapping has been changed successfully",actionlabel:["Go To Homepage","Upload Data For This Entity"]}).then(function(u){if(!u){n.reset();n.removePath(1)}if(u){n.removePath(1);n.editEntity();n.uploadData("Upload Data")}})}else{f.alertBox({title:"Alert",message:"Mapping is not Changed.Please try again",actionlabel:["Ok"]}).then(function(u){})}}).error(function(s){n.hideLoader();n.serverError()})}}};n.validateInvalidRecords=function(u){var t=k("byProp")(u,"isvalid","valid");var s=k("byProp")(u,"isvalid","invalid");for(var r=0;r<s.length;r++){angular.forEach(s[r],function(w,v){if(Object.prototype.toString.call(w)==="[object String]"){var x=w.replace(/,/g,"^^");s[r][v]=x}})}var q=t.concat(s);var p=k("extractProperty")(n.templateData,"excelcolumnheader");p=k("replaceInArray")(p,/,/g,"^^");var o=p.join(",");angular.forEach(q,function(x){o=o+"\n";var v=[];for(var w=0;w<p.length;w++){var y=x[p[w].toLowerCase()];y=y.replace(/,/g,"^^");v.push(y)}o=o+v.join(",")});n.validate(o)};n.truncateStaging=function(p){var o="y";n.submitValidRecords(p,o)};n.submitRecords=function(p){var o="n";n.submitValidRecords(p,o)};n.submitBatchRecords=function(r){var q=[];for(var p=0;p<r.length;p++){q.push(r[p]["batch id"])}if(q.length>0){var o=q.join("~");var r=[{processName:"INSERTINTOMASTER",data:[{x_entityid:n.currentEntity.id,x_batch_id:o}]}];n.showLoader("Moving Data To Master");a.callPlatware(r).success(function(s){var w=e.parse(s);n.hideLoader();for(var t=0;t<w.length;t++){if(w[t].isError=="N"){if(w[t].processName=="INSERTINTOMASTER"){var v=w[t].data[0]["message"];var u="";if(w[t].data[0]["info"]&&w[t].data[0]["info"].length>0){u=w[t].data[0]["info"]}else{u="Data has been moved to master successfully"}if(v.toLowerCase()=="success"){f.alertBox({title:"Proceed",message:u,actionlabel:[]}).then(function(x){});n.showScreenControls.optsClass="slide-down";n.reset();n.removePath(1);g.path("/mainpage2")}else{f.alertBox({title:"Proceed",message:"Some error occured while moving to master",actionlabel:[]}).then(function(x){})}}}else{f.alertBox({title:"Proceed",message:"Some error occured while moving to master",actionlabel:[]}).then(function(x){})}}}).error(function(){n.hideLoader();n.serverError()})}else{f.alertBox({title:"Alert",message:"Select batch id(s) to be moved to master.",actionlabel:[]}).then(function(s){})}};n.submitValidRecords=function(s,q){var p=k("byProp")(s,"isvalid","invalid");var o=k("byProp")(s,"isvalid","valid");var r=o.length+p.length;function t(){if(o.length>0){var y=n.currentEntity.id;var w=n.curBatchId;var v=k("extractProperty")(o,"attributeid");v=v[0].split("~").join(",");var x=k("extractProperty")(o,"heading");x=x[0].split("~");var A;var z=k("extractProperty")(n.templateData,"excelcolumnheader");z=k("replaceInArray")(z,/,/g,"^^");var u={key1:o,key2:v,key3:z,key4:n.attributeList};var B=d.submitData(u);B.then(function(E){if(E[0]["type"]=="submitData"){var C=Object.keys(E[0]["data"]).length;var G=0;var F=0;function D(H,L){var M=5;for(var J=1;J<=H;J++){F++;var K=E[0]["data"][F];var I=[{processName:"INSERTINTOSTAGING",data:[{x_entityid:y,x_valuestring:K,x_attributeid:v,x_is_truncate:L,x_batch_id:w,x_filename:n.fileName}]}];n.showLoader("Submitting "+G+" of "+C+" batches of data");a.callPlatware(I).success(function(Q){var O=e.parse(Q);for(var S=0,N=O.length;S<N;S++){if(O[S]["isError"]==="N"){if(O[S]["data"][0]["issuccess"]){if(O[S]["data"][0]["issuccess"]&&O[S]["data"][0]["issuccess"]=="Y"){G++;if(G==C){n.hideLoader();n.showLoader("Data Submitted Successfully and Getting Refresh Staging Data");n.getStagingData("",function(X){var W=p.concat(o);var V=k("extractProperty")(n.templateData,"excelcolumnheader");V=k("replaceInArray")(V,/,/g,"^^");var U=V.join(",");angular.forEach(W,function(ab){U=U+"\n";var Z=[];for(var aa=0;aa<V.length;aa++){var ac=ab[V[aa].toLowerCase()];ac=ac.replace(/,/g,"^^");Z.push(ac)}U=U+Z.join(",")});var Y={key1:U,key2:n.attributeList,key3:V,key4:n.stagingData,key5:n.action_name,key6:n.rejectionData,key7:n.masterData};var T=d.doWork(Y,n.workerConfig);T.then(function(ad){for(var aa=0,Z=ad.length;aa<Z;aa++){if(ad[aa]["type"].toLowerCase()=="tabledata"){var ac=ad[aa]["data"];var ab=k("replacePropValue")(ac,"isvalid","valid","submitted");n.tableData=ab;n.showScreenControls.showSlideUpIcon=true;n.showScreenControls.showTable=true;n.hideLoader();f.alertBox({title:"Submit Alert",message:"Data Submitted Successfully",actionlabel:["Ok"]}).then(function(ae){g.path("/batch/"+n.currentEntity.id);n.$broadcast("switchTab","staging data")})}}})})}else{if(F===G){var R=C-G;if(R>M){var P=M}else{P=R}D(P,"N")}}}else{f.alertBox({title:"Submit Alert",message:"error while inserting into staging table",actionlabel:["Ok"]}).then(function(T){});n.hideLoader()}}}else{f.alertBox({title:"Submit Alert",message:"error while inserting into staging table",actionlabel:["Ok"]}).then(function(T){});n.hideLoader()}}}).error(function(N){n.hideLoader();n.serverError()})}}D(1,q)}})}else{f.alertBox({title:"Template Alert",message:"No Valid Records to submit",actionlabel:["Ok"]}).then(function(C){})}}if(p.length>0){f.confirmBox({title:"Proceed",message:"Proceed to submit "+o.length+" valid records of "+r+" records",actionlabel:["Cancel","Ok"]}).then(function(u){if(u){t()}})}else{t()}};n.getRejectionData=function(p,r){var q=n.currentEntity.id;var o=[{processName:"SPREJECTIONDATA",data:[{x_entityid:q}]}];n.showLoader();a.callPlatware(o).success(function(t){var w=e.parse(t);n.hideLoader();for(var u=0,s=w.length;u<s;u++){if(w[u]["isError"]=="N"){n.rejectionData=w[u]["data"];if(!r){n.rejectionData=w[u]["data"]}else{n.rejectionData=w[u]["data"];r(n.rejectionData)}if(n.rejectionData.length>0){var v=Object.keys(n.rejectionData[0]);v=v.join("~");n.rejectDataHeading=v;n.makeRejectionHeaders()}}else{f.alertBox({title:"Data alert",message:"error while getting rejection data",actionlabel:["Ok"]}).then(function(x){});n.hideLoader()}}}).error(function(s){n.hideLoader();n.serverError()})};n.makeRejectionHeaders=function(){for(var p=0,o=n.rejectionData.length;p<o;p++){n.rejectionData[p]["heading"]=n.rejectDataHeading}};n.makeMasterHeaders=function(){for(var p=0,o=n.masterData.length;p<o;p++){n.masterData[p]["heading"]=n.masterDataHeading}};n.getMasterData=function(r,p,q){var r=r||"0";var o=[{processName:"GETMASTERDATA",data:[{x_start_index:parseInt(r)+1+"",x_entityid:n.currentEntity.id}]}];n.showLoader("Getting Master Table Data");a.callPlatware(o).success(function(t){var w=e.parse(t);n.hideLoader();for(var u=0,s=w.length;u<s;u++){if(w[u]["isError"]=="N"){if(!q&&r){n.masterTableData=w[u]["data"];n.collectiveServerCalls={showServerPagination:true,totalRecordCount:n.masterData[0]["total_records"],batchCount:n.masterData[0]["batch_count"]};n.showScreenControls.showMasterTable=true}else{if(!q){n.masterData=w[u]["data"]}else{n.masterData=w[u]["data"];q(n.masterData)}}if(n.masterData.length>0){if(n.masterData[0].heading&&n.masterData[0].heading.length>0){n.masterDataHeading=n.masterData[0].heading}else{var v=Object.keys(n.masterData[0]);v=v.join("~");n.masterDataHeading=v;n.makeMasterHeaders()}}}else{f.alertBox({title:"Data alert",message:"error while getting master data",actionlabel:["Ok"]}).then(function(x){});n.hideLoader()}}}).error(function(s){n.hideLoader();n.serverError()})};n.getStagingData1=function(){var o="";g.path("/batch/"+o)};n.getStagingData=function(p,r){var q=n.currentEntity.id;var o=[{processName:"GETBATCHLIST",data:[{x_entityid:q}]}];n.showLoader("Getting Staging Data");a.callPlatware(o).success(function(t){var v=e.parse(t);n.hideLoader();for(var u=0,s=v.length;u<s;u++){if(v[u]["isError"]=="N"){if(!r){n.stagingData=v[u]["data"]}else{n.stagingData=v[u]["data"];r(n.stagingData)}}else{f.alertBox({title:"Alert",message:"Error From Server Side",actionlabel:["Ok"]}).then(function(w){});r(null)}}}).error(function(){n.hideLoader();n.serverError()})};n.stagingToMaster=function(){var o=[{processName:"INSERTINTOMASTER",data:[{x_entityid:n.currentEntity.id}]}];n.showLoader("Moving Data To Master");a.callPlatware(o).success(function(p){var t=e.parse(p);n.hideLoader();for(var q=0;q<t.length;q++){if(t[q].isError=="N"){if(t[q].processName=="INSERTINTOMASTER"){var s=t[q].data[0]["message"];var r="";if(t[q].data[0]["info"]&&t[q].data[0]["info"].length>0){r=t[q].data[0]["info"]}else{r="Data has been moved to master successfully"}if(s=="success"){f.alertBox({title:"Proceed",message:r,actionlabel:[]}).then(function(u){});n.showScreenControls.optsClass="slide-down";n.reset();n.removePath(1);n.getBatch()}else{f.alertBox({title:"Proceed",message:"Some error occured while moving to master",actionlabel:[]}).then(function(u){})}}}else{f.alertBox({title:"Proceed",message:"Some error occured while moving to master",actionlabel:[]}).then(function(u){})}}}).error(function(){n.hideLoader();n.serverError()})};n.selectFileHeader=function(o){n.selectedFileHeaderIndex=o};n.selectMappedHeader=function(o){n.selectedMappedHeaderIndex=o};n.checkForMappedHeaders=function(){var o=true;for(i=0;i<n.droppedData.length;i++){if(n.droppedData[i]["data"]==""){o=false}}return o};n.$watch(function(){return n.entityItem},function(o){if(o){n.selectEntity(n.entityItem);n.showScreenControls.sheetsObj.sheets=[];n.fileName=""}else{n.templateList=[]}});n.$watch(function(){return n.stagingEntityItem},function(o){if(o){n.setStagingBatchAttribute(n.stagingEntityItem)}});n.$watch(function(){return n.masterEntityItem},function(o){if(o){n.selectEntity(n.masterEntityItem)}});n.$watch(function(){return n.rejectedEntityItem},function(o){if(o){n.selectEntity(n.rejectedEntityItem)}});n.$watch(function(){return n.templateItem},function(o){if(o){n.selectTemplate(n.templateItem)}});n.$watch(function(){return n.showScreenControls.orgItem},function(o){if(o){n.selectOrgs(n.showScreenControls.orgItem)}});n.refreshBtn=function(q){var p=k("byProp")(q,"isvalid","invalid");var o=k("byProp")(q,"isvalid","valid");n.getStagingData("",function(v){var u=p.concat(o);var t=n.showScreenControls.headers.join(",");angular.forEach(u,function(z){t=t+"\n";var x=[];for(var y=0;y<n.showScreenControls.headers.length;y++){x.push(z[n.showScreenControls.headers[y].toLowerCase()])}t=t+x.join(",")});var s=k("extractProperty")(n.templateData,"excelcolumnheader");s=k("replaceInArray")(s,/,/g,"^^");var w={key1:t,key2:n.attributeList,key3:s,key4:n.stagingData,key5:n.action_name,key6:n.rejectionData,key7:n.masterData};var r=d.doWork(w,n.workerConfig);n.showLoader("Validating Records");r.then(function(B){n.hideLoader();for(var y=0,x=B.length;y<x;y++){if(B[y]["type"].toLowerCase()=="tabledata"){var A=B[y]["data"];var z=k("replacePropValue")(A,"isvalid","valid","submitted");n.tableData=z;n.showScreenControls.showSlideUpIcon=true;n.showScreenControls.showTable=true;n.$broadcast("switchTab","staging data")}}})})};n.refreshMasterBtn=function(q){var p=k("byProp")(q,"isvalid","invalid");var o=k("byProp")(q,"isvalid","valid");n.getMasterData("",function(s){var v=p.concat(o);var u=n.showScreenControls.headers.join(",");angular.forEach(v,function(z){u=u+"\n";var x=[];for(var y=0;y<n.showScreenControls.headers.length;y++){x.push(z[n.showScreenControls.headers[y].toLowerCase()])}u=u+x.join(",")});var t=k("extractProperty")(n.templateData,"excelcolumnheader");t=k("replaceInArray")(t,/,/g,"^^");var w={key1:u,key2:n.attributeList,key3:t,key4:n.stagingData,key5:n.action_name,key6:n.rejectionData,key7:n.masterData};var r=d.doWork(w,n.workerConfig);n.showLoader("Validating Records");r.then(function(B){n.hideLoader();for(var y=0,x=B.length;y<x;y++){if(B[y]["type"].toLowerCase()=="tabledata"){var A=B[y]["data"];var z=k("replacePropValue")(A,"isvalid","valid","submitted");n.tableData=z;n.showScreenControls.showSlideUpIcon=true;n.showScreenControls.showTable=true;n.$broadcast("switchTab","master data")}}})})};n.refreshStaging=function(o){n.getStagingData(n.action_name,n.stagingDataTable)};n.refreshMaster=function(o){n.getMasterData("0",n.action_name,n.masterDataTable)};n.refreshRejected=function(o){n.getRejectionData(n.action_name,n.rejectedDataTable)};n.generateFileHeaders=function(){var q=[];n.attributeList=k("orderObjectBy")(n.attributeList,"attributeid");for(var p=0;p<n.attributeList.length;p++){var o=n.attributeList[p]["attributename"].trim();q.push(o)}n.genratedFileHeaders=q};n.generateFile=function(r){var p="";var q=c.excelData(n.genratedFileHeaders,p,true);r.target.download="data.xls";var o=c.uri.excel+c.base64(q);r.target.href=o};n.excelData=function(t,s){var p="<table><tbody><tr>";for(var q=0;q<t.length;q++){p=p+"<th>"+t[q]["columnName"]+"</th>"}p=p+"</tr>";for(var q=0;q<s.length;q++){var r=s[q].invalidreason;p=p+"<tr>";for(var o=0;o<t.length;o++){if(t[o]["columnType"].toLowerCase()!="select"||t[o]["columnType"].toLowerCase()!="button"){if(t[o]["columnId"] in r){p=p+'<td style="background:red">'+s[q][t[o]["columnId"]]+"</td>"}else{p=p+"<td>"+s[q][t[o]["columnId"]]+"</td>"}}}p=p+"</tr>"}p=p+"</tbody></table>";return p};n.refreshRejectionData=function(q){var p=k("byProp")(q,"isvalid","invalid");var o=k("byProp")(q,"isvalid","valid");n.getRejectionData("",function(){var u=p.concat(o);var t=n.showScreenControls.headers.join(",");angular.forEach(u,function(y){t=t+"\n";var w=[];for(var x=0;x<n.showScreenControls.headers.length;x++){w.push(y[n.showScreenControls.headers[x].toLowerCase()])}t=t+w.join(",")});var s=k("extractProperty")(n.templateData,"excelcolumnheader");s=k("replaceInArray")(s,/,/g,"^^");var v={key1:t,key2:n.attributeList,key3:s,key4:n.stagingData,key5:n.action_name,key6:n.rejectionData,key7:n.masterData};var r=d.doWork(v,n.workerConfig);n.showLoader("Validating Records");r.then(function(A){n.hideLoader();for(var x=0,w=A.length;x<w;x++){if(A[x]["type"].toLowerCase()=="tabledata"){var z=A[x]["data"];var y=k("replacePropValue")(z,"isvalid","valid","submitted");n.tableData=y;n.showScreenControls.showSlideUpIcon=true;n.showScreenControls.showTable=true;n.$broadcast("switchTab","staging data")}}})})}}]);mainpageModule.filter("byProp",function(){return function(e,d,c){var a=[],b=[];if(c&&c.length>0){angular.forEach(e,function(f){f[d].toLowerCase()===c.toLowerCase()?a.push(f):""})}return a}});mainpageModule.filter("filterMyData",function(){return function(c,d,b){var a=[];angular.forEach(c,function(e){a.push({prop1:e[d],prop2:e[b]})});return a}});